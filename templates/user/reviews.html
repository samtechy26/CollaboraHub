{% extends 'dashboard/base.html' %}
{% block content %}
    <!-- Dashboard Headline -->
			<div class="dashboard-headline">
				<h3>Reviews</h3>

				<!-- Breadcrumbs -->
				<nav id="breadcrumbs" class="dark">
					<ul>
						<li><a href="#">Home</a></li>
						<li><a href="#">Dashboard</a></li>
						<li>Reviews</li>
					</ul>
				</nav>
			</div>
	
			<!-- Row -->
			<div class="row">

				<!-- Dashboard Box -->
				<div class="col-xl-6">
					<div class="dashboard-box margin-top-0">

						<!-- Headline -->
						<div class="headline">
							<h3><i class="icon-material-outline-business"></i> Rate Employers</h3>
						</div>

						<div class="content">
							<ul class="dashboard-box-list">
                                {% for job in jobs %}
                                {% if job.active %}
                                <li>
									<div class="boxed-list-item">
										<!-- Content -->
										<div class="item-content">
											<h4>{{job.project.title}}</h4>
											<div class="item-details margin-top-10">
												<div class="star-rating" data-rating="{{job.rating}}"></div>
												<div class="detail-item"><i class="icon-material-outline-date-range"></i> {{job.created}}</div>
                                                
											</div>
                                            <p>Job posted by <strong>{{job.employer}}</strong></p>
											<div class="item-description">
												<p>{{job.comment}}</p>
											</div>
										</div>
									</div>
                                    {% if request.user == job.freelancer %}
                                    <a href="#small-dialog-1" id="freelancer-edit-review" class=" edit-reviews popup-with-zoom-anim button gray ripple-effect margin-top-5 margin-bottom-10"\
                                      data-comment="{{job.comment}}" data-isFreelancer="true" data-freelancer="{{request.user.username}}" data-rating="{{job.rating}}" data-project="{{job.id}}" data-employer="{{job.employer}}" \
                                     data-onBudget="{{job.on_budget}}" data-timely="{{job.timely}}" data-subject="{{job.project.title}}"><i  class="icon-feather-edit"></i> Edit Review</a>
                                    {% endif %}	
								</li>
                                {% else %}
                                <li>
									<div class="boxed-list-item">
										<!-- Content -->
										<div class="item-content">
											<h4>{{job.title}}</h4>
                                            <div class="detail-item"><i class="icon-material-outline-date-range"></i> {{job.date_created}}</div>
											<span class="company-not-rated margin-bottom-5">Not Rated</span>
										</div>
									</div>
                                    <a href="#small-dialog-2" id="freelancer-add-review" class="add-reviews popup-with-zoom-anim button ripple-effect margin-top-5 margin-bottom-10"  data-project="{{job.id}}" data-freelancer="{{request.user}}" data-employer="{{job.author}}" ><i  class="icon-material-outline-thumb-up"></i> Leave a Review</a>
								</li>
                                {% endif %}
                                
                                {% endfor %}

							</ul>
						</div>
					</div> 

					<!-- Pagination -->
					<div class="clearfix"></div>
					{% include "pagination.html" with page=jobs %}
					<div class="clearfix"></div>
					<!-- Pagination / End -->

				</div>

				<!-- Dashboard Box -->
				<div class="col-xl-6">
					<div class="dashboard-box margin-top-0">

						<!-- Headline -->
						<div class="headline">
							<h3><i class="icon-material-outline-face"></i> Rate Freelancers</h3>
						</div>

						<div class="content">
							<ul class="dashboard-box-list">
								 {% for job in jobs %}
                                {% if job.active %}
                                <li>
									<div class="boxed-list-item">
										<!-- Content -->
										<div class="item-content">
											<h4>{{job.project.title}}</h4>
											<div class="item-details margin-top-10">
												<div class="star-rating" data-rating="{{job.rating}}"></div>
												<div class="detail-item"><i class="icon-material-outline-date-range"></i> {{job.created}}</div>
                                                
											</div>
                                            <p>Job done by <strong>{{job.freelancer}}</strong></p>
											<div class="item-description">
												<p>{{job.comment}}</p>
											</div>
										</div>
									</div>
                                    {% if request.user == job.employer %}
                                    <a href="#small-dialog-1" id="employer-edit-review" class=" edit-reviews popup-with-zoom-anim button gray ripple-effect margin-top-5 margin-bottom-10 edit-review" data-rating="{{job.rating}}" \
                                    data-comment="{{job.comment}}" data-onBudget="{{job.on_budget}}" data-timely="{{job.timely}}"\
                                     data-freelancer="{{job.freelancer}}" data-employer="{{request.user.username}}"  data-subject="{{job.project.title}}" data-project="{{job.id}}" ><iclass="icon-feather-edit"></i> Edit Review</a>
                                    {% endif %}	
								</li>
                                {% else %}
                                <li>
									<div class="boxed-list-item">
										<!-- Content -->
										<div class="item-content">
											<h4>{{job.title}}</h4>
                                            <div class="detail-item"><i class="icon-material-outline-date-range"></i> {{job.date_created}}</div>
											<span class="company-not-rated margin-bottom-5">Not Rated</span>
										</div>
									</div>
                                    <a href="#small-dialog-2" class="add-reviews popup-with-zoom-anim button ripple-effect margin-top-5 margin-bottom-10" id="freelancer-add-review"  data-freelancer="{{request.user}}" data-employer="{{job.author}}" data-subject="{{job.title}}" data-project="{{job.id}}"><i    class="icon-material-outline-thumb-up"></i> Leave a Review</a>
								</li>
                                {% endif %}
                                
                                {% endfor %}

							</ul>
						</div>
					</div>
				</div>


			</div>

            
			<!-- Row / End -->
            <div id="small-dialog-1" class="zoom-anim-dialog mfp-hide dialog-with-tabs">

                <!--Tabs -->
                <div class="sign-in-form">
            
                    <ul class="popup-tabs-nav">
                    </ul>
            
                    <div class="popup-tabs-container">
            
                        <!-- Tab -->
                        <div class="popup-tab-content" id="tab1">
                            
                            <!-- Welcome Text -->
                            <div class="welcome-text">
                                <h3 >Change Review</h3>
                                <span>Rate <a href="#" id="edit-employer-name">Herman Ewout</a> for the project <a href="#" id="edit-project-name">WordPress Theme Installation</a> </span>
                            </div>
                                
                            <!-- Form -->
                            <form method="post" action="#" id="change-review-form">
            
                                <div class="feedback-yes-no">
                                    <strong id="edit-onBudget">Was this delivered on budget?</strong>
                                    <div class="radio" >
                                        <input id="radio-rating-1" name="radio" type="radio" checked>
                                        <label for="radio-rating-1"><span class="radio-label"></span> Yes</label>
                                    </div>
            
                                    <div class="radio">
                                        <input id="radio-rating-2" name="radio" type="radio">
                                        <label for="radio-rating-2"><span class="radio-label"></span> No</label>
                                    </div>
                                </div>
            
                                <div class="feedback-yes-no">
                                    <strong>Was this delivered on time?</strong>
                                    <div class="radio">
                                        <input id="radio-rating-3" name="radio2" type="radio" checked>
                                        <label for="radio-rating-3"><span class="radio-label"></span> Yes</label>
                                    </div>
            
                                    <div class="radio">
                                        <input id="radio-rating-4" name="radio2" type="radio">
                                        <label for="radio-rating-4"><span class="radio-label"></span> No</label>
                                    </div>
                                </div>
            
                                <div class="feedback-yes-no">
                                    <strong>Your Rating</strong>
                                    <div class="leave-rating" id="edit-rating">
                                        <input type="radio" name="rating1" id="rating-1" value="1" checked/>
                                        <label for="rating-1" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating1" id="rating-2" value="2"/>
                                        <label for="rating-2" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating1" id="rating-3" value="3"/>
                                        <label for="rating-3" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating1" id="rating-4" value="4"/>
                                        <label for="rating-4" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating1" id="rating-5" value="5"/>
                                        <label for="rating-5" class="icon-material-outline-star"></label>
                                    </div><div class="clearfix"></div>
                                </div>
            
                                
                                <textarea class="with-border" placeholder="Comment" name="message" id="message" cols="7" required>Excellent programmer - helped me fixing small issue.</textarea>
                                {% csrf_token %}
                                <button class="button full-width button-sliding-icon ripple-effect" id="save-review" type="submit" form="change-review-form">Save Changes <i class="icon-material-outline-arrow-right-alt"></i></button>
                            </form>
                            
                            <!-- Button -->
                           
            
                        </div>
            
                    </div>
                </div>
            </div>
             
            
            <!-- Leave a Review for Freelancer Popup
            ================================================== -->
            <div id="small-dialog-2" class="zoom-anim-dialog mfp-hide dialog-with-tabs">
            
                <!--Tabs -->
                <div class="sign-in-form">
            
                    <ul class="popup-tabs-nav">
                    </ul>
            
                    <div class="popup-tabs-container">
            
                        <!-- Tab -->
                        <div class="popup-tab-content" id="tab2">
                            
                            <!-- Welcome Text -->
                            <div class="welcome-text">
                                <h3>Leave a Review</h3>
                                <span>Rate <a href="#">Peter Valentín</a> for the project <a href="#">Simple Chrome Extension</a> </span>
                            </div>
                                
                            <!-- Form -->
                            <form method="post" action="#" id="leave-review-form">
            
                                <div class="feedback-yes-no">
                                    <strong>Was this delivered on budget?</strong>
                                    <div class="radio">
                                        <input id="radio-1" name="radio" type="radio" required value="1">
                                        <label for="radio-1"><span class="radio-label"></span> Yes</label>
                                    </div>
            
                                    <div class="radio">
                                        <input id="radio-2" name="radio" type="radio" required value="0">
                                        <label for="radio-2"><span class="radio-label"></span> No</label>
                                    </div>
                                </div>
            
                                <div class="feedback-yes-no">
                                    <strong>Was this delivered on time?</strong>
                                    <div class="radio">
                                        <input id="radio-3" name="radio2" type="radio" required value="1">
                                        <label for="radio-3"><span class="radio-label"></span> Yes</label>
                                    </div>
            
                                    <div class="radio">
                                        <input id="radio-4" name="radio2" type="radio" required value="0">
                                        <label for="radio-4"><span class="radio-label"></span> No</label>
                                    </div>
                                </div>
            
                                <div class="feedback-yes-no">
                                    <strong>Your Rating</strong>
                                    <div class="leave-rating">
                                        <input type="radio" name="rating" id="rating-radio-1" value="1" required>
                                        <label for="rating-radio-1" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating" id="rating-radio-2" value="2" required>
                                        <label for="rating-radio-2" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating" id="rating-radio-3" value="3" required>
                                        <label for="rating-radio-3" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating" id="rating-radio-4" value="4" required>
                                        <label for="rating-radio-4" class="icon-material-outline-star"></label>
                                        <input type="radio" name="rating" id="rating-radio-5" value="5" required>
                                        <label for="rating-radio-5" class="icon-material-outline-star"></label>
                                    </div><div class="clearfix"></div>
                                </div>
            
                                <textarea class="with-border" placeholder="Comment" name="message2" id="message2" cols="7" required></textarea>
                                {% csrf_token %}
                                <button  id="leave-review" class="button full-width button-sliding-icon ripple-effect" type="button" form="leave-review-form">Leave a Review <i class="icon-material-outline-arrow-right-alt"></i></button>
                            </form>
                            
                            <!-- Button -->
                            
            
                        </div>
            
                    </div>
                </div>
            </div>
            <!-- Leave a Review Popup / End -->
            
            
            
            <!-- Scripts
            ================================================== -->
            <script src="js/jquery-3.3.1.min.js"></script>
            <script src="js/jquery-migrate-3.0.0.min.js"></script>
            <script src="js/mmenu.min.js"></script>
            <script src="js/tippy.all.min.js"></script>
            <script src="js/simplebar.min.js"></script>
            <script src="js/bootstrap-slider.min.js"></script>
            <script src="js/bootstrap-select.min.js"></script>
            <script src="js/snackbar.js"></script>
            <script src="js/clipboard.min.js"></script>
            <script src="js/counterup.min.js"></script>
            <script src="js/magnific-popup.min.js"></script>
            <script src="js/slick.min.js"></script>
            <script src="js/custom.js"></script>
            
            <!-- Snackbar // documentation: https://www.polonel.com/snackbar/ -->
            <script>
            // Snackbar for user status switcher
            $('#snackbar-user-status label').click(function() { 
                Snackbar.show({
                    text: 'Your status has been changed!',
                    pos: 'bottom-center',
                    showAction: false,
                    actionText: "Dismiss",
                    duration: 3000,
                    textColor: '#fff',
                    backgroundColor: '#383838'
                }); 
            }); 
            </script>
            
            <!-- Chart.js // documentation: http://www.chartjs.org/docs/latest/ -->
            <script src="js/chart.min.js"></script>
            <script>
                Chart.defaults.global.defaultFontFamily = "Nunito";
                Chart.defaults.global.defaultFontColor = '#888';
                Chart.defaults.global.defaultFontSize = '14';
            
                var ctx = document.getElementById('chart').getContext('2d');
            
                var chart = new Chart(ctx, {
                    type: 'line',
            
                    // The data for our dataset
                    data: {
                        labels: ["January", "February", "March", "April", "May", "June"],
                        // Information about the dataset
                           datasets: [{
                            label: "Views",
                            backgroundColor: 'rgba(42,65,232,0.08)',
                            borderColor: '#2a41e8',
                            borderWidth: "3",
                            data: [196,132,215,362,210,252],
                            pointRadius: 5,
                            pointHoverRadius:5,
                            pointHitRadius: 10,
                            pointBackgroundColor: "#fff",
                            pointHoverBackgroundColor: "#fff",
                            pointBorderWidth: "2",
                        }]
                    },
            
                    // Configuration options
                    options: {
            
                        layout: {
                          padding: 10,
                          },
            
                        legend: { display: false },
                        title:  { display: false },
            
                        scales: {
                            yAxes: [{
                                scaleLabel: {
                                    display: false
                                },
                                gridLines: {
                                     borderDash: [6, 10],
                                     color: "#d8d8d8",
                                     lineWidth: 1,
                                },
                            }],
                            xAxes: [{
                                scaleLabel: { display: false },  
                                gridLines:  { display: false },
                            }],
                        },
            
                        tooltips: {
                          backgroundColor: '#333',
                          titleFontSize: 13,
                          titleFontColor: '#fff',
                          bodyFontColor: '#fff',
                          bodyFontSize: 13,
                          displayColors: false,
                          xPadding: 10,
                          yPadding: 10,
                          intersect: false
                        }
                    },
            
            
            });
            
            </script>
            <script>
                // submit a review 
                
                var editReviews = document.getElementsByClassName("edit-reviews");

                // prefill the pop-up form with values
                Array.prototype.forEach.call(editReviews,(element)=>{
                    element.addEventListener("click", function(){
                        employer = element.dataset.employer;
                        freelancer = element.dataset.freelancer;
                        review_id = element.dataset.project;
                        subject = element.dataset.subject;
                        rating = element.dataset.rating;
                        onBudget = element.dataset.onBudget;
                        timely = element.dataset.timely;
                        comment = element.dataset.comment;
                        isFreelancer = element.dataset.isFreelancer;
                        // prefill
                    if (document.querySelector("#small-dialog-1").style.display != "none"){
                        
                        if (isFreelancer){
                            document.querySelector("#edit-employer-name").innerHTML = freelancer;
                        }else{
                            document.querySelector("#edit-employer-name").innerHTML = employer;
                        }
                        
                        document.querySelector("#edit-project-name").innerHTML = subject;
                        if (onBudget == "True"){
                            document.querySelector("#radio-rating-1").checked = true;
                        }else{
                            document.querySelector("#radio-rating-2").checked = true;
                        }
                        if (timely == "True"){
                            document.querySelector("#radio-rating-3").checked = true;
                        }else{
                            document.querySelector("#radio-rating-4").checked = true;
                        }

                        document.querySelector(`#rating-radio-${rating}`).checked = true;
                        
                        document.querySelector("#message").innerHTML= comment;

                    }

                    // submit the form
                    document.getElementById("save-review").addEventListener("click", function(){
                        onBudget = document.querySelector('input[name="radio"]:checked').value;
                        timely = document.querySelector('input[name="radio2"]:checked').value;
                        rating = document.querySelector('input[name="rating1"]:checked').value;
                        comment = document.querySelector("#message").value;
                        var csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                          fetch("{% url 'add_review' %}", {

                            method: "PUT",
                            headers: {
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify({
                                rating: rating,
                                timely: timely,
                                on_budget: onBudget,
                                comment:comment,
                                reveiw_id: review_id
                            })
                        })
                        .then((response)=>{
                            return response.json();
                        })
                        .then((result)=>{
                            alert(result.message);
                            window.location.reload();

                        })
                        .then((err)=>{
                            console.error(err);
                        })
                        })
                    
                    })
                })
       

                
                // submit a new review 
                var addReviews = document.getElementsByClassName("add-reviews");

                Array.prototype.forEach.call(addReviews, (element)=>{
                    element.addEventListener("click", function(){
                        var project_id = element.dataset.project;
                        var freelancer = element.dataset.freelancer;
                        var employer = element.dataset.employer;

                        // submit form 
                        document.getElementById("leave-review").addEventListener("click", function(){
                            onBudget = document.querySelector('input[name="radio"]:checked').value;
                            timely = document.querySelector('input[name="radio2"]:checked').value;
                            rating = document.querySelector('input[name="rating"]:checked').value;
                            comment = document.querySelector("#message2").value;
                            var csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            fetch("{% url 'add_review' %}", {
                            method: "POST",
                            headers: {
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify({
                                rating: rating,
                                timely: timely,
                                on_budget: onBudget,
                                comment:comment,
                                freelancer:freelancer,
                                employer: employer,
                                project: project_id
                            })
                        })
                        .then((response)=>{
                            return response.json();
                        })
                        .then((result)=>{
                            alert(result.message);
                            window.location.reload();

                        })
                        .then((err)=>{
                            console.error(err);
                        })

                        })
                        })
                    })

     
            </script>
{% endblock content %}
